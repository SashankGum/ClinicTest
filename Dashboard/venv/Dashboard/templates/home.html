{% extends 'layouts.html'%}

{% block body %}
	<div class="jumbotron text-center">
		<h1>Welcome to ClinicDash</h1>
		<p class="lead">PostgreSQL Query result: </p>
	</div>
	<div>
	<script>

//Map dimensions (in pixels)
var width = 800,
    height = 500;

//Map projection
var projection = d3.geo.albersUsa()
    .scale(972.94948229494)
    .translate([width/2,height/2]) //translate to center the map in view

//Generate paths based on projection
var path = d3.geo.path()
    .projection(projection);

//Create an SVG
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

//Group for the map features
var features = svg.append("g")
    .attr("class","features");

//Create zoom/pan listener
//Change [1,Infinity] to adjust the min/max zoom scale
var zoom = d3.behavior.zoom()
    .scaleExtent([1, Infinity])
    .on("zoom",zoomed);

svg.call(zoom);

//Create a tooltip, hidden at the start
var tooltip = d3.select("body").append("div").attr("class","tooltip");

d3.json("{{url_for('static', filename='gz_2010_us_050_00_5m.topojson')}}",function(error,geodata) {
	console.log(geodata)
  if (error) return console.log(error); //unknown error, check the console

  //Create a path for each map feature in the data
  features.selectAll("path")
    .data(topojson.feature(geodata,geodata.objects.gz_2010_us_050_00_5m).features) //generate features from TopoJSON
    .enter()
    .append("path")
    .attr("d",path)
    .on("mouseover",showTooltip)
    .on("mousemove",moveTooltip)
    .on("mouseout",hideTooltip)
    .on("click",clicked);

});

// Add optional onClick events for features here
// d.properties contains the attributes (e.g. d.properties.name, d.properties.population)
function clicked(d,i) {

}


//Update map on zoom/pan
function zoomed() {
  features.attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
}


//Position of the tooltip relative to the cursor
var tooltipOffset = {x: 5, y: -25};

//Create a tooltip, hidden at the start
function showTooltip(d) {
  moveTooltip();
  tooltip.style("display","block")
      .text("Area: "+d.properties.NAME+" | Population: "+d.properties.CENSUSAREA);
}

//Move the tooltip to track the mouse
function moveTooltip() {
  tooltip.style("top",(d3.event.pageY+tooltipOffset.y)+"px")
      .style("left",(d3.event.pageX+tooltipOffset.x)+"px");
}

//Create a tooltip, hidden at the start
function hideTooltip() {
  tooltip.style("display","none");
}
</script>
</div>
		<div id="zerostate"></div>
		<script type="text/javascript">
			// For chart one - (Bar chart)
			var zeroChart = dc.rowChart("#zerostate");
			var data = {{results | tojson}}
			var ndx = crossfilter(data);
			var all = ndx.groupAll();
			var nameDimension = ndx.dimension(function(d){ return d[0]["name"];});
			nameDimension.filter("Neurology");
			var nearbyCompetition = all.value();
			nameDimension.filterAll();
			var nameGroup = nameDimension.group();

			// For national Average - (Number Display)
			
			var nat_avg = {{national_avg | tojson}}
			var nacf = crossfilter(nat_avg);
			var na_nameDimension = nacf.dimension(function(d){ return d[0]["name"];});
			// na_nameDimension.filter("Neurology");
			// var na_all = nacf.groupAll().reduceSum(function(fact){ return fact[0]["national_avg"];}).value()
			
			// console.log("national avg for Neurology is:"+na_all);

			zeroChart
   .width(768)
    .height(480)
    //.x(d3.scaleLinear().domain([6,20]))
    .elasticX(true).filter("Neurology")
				.dimension(nameDimension)
				.group(nameGroup)
				.rowsCap(10)
				.othersGrouper(false).addFilterHandler(function (filters, filter) {
    filters.length = 0; // empty the array
    filters.push(filter);
    return filters;
});;

		zeroChart.on('filtered', function (chart) {
         var filters = chart.filters();
         na_nameDimension.filterAll();
         if (filters.length) {
             console.log(filters[0]+"    and value:"+all.value());
             na_nameDimension.filter(filters[0]);
			var na_nameGroup = nacf.groupAll().reduceSum(function(fact){ return fact[0]["national_avg"];})
			//na_all = na_nameGroup.value()
		var boxNatAvg = dc.numberDisplay("#natAvg");
		boxNatAvg
		.formatNumber(d3.format(".3s"))
        .valueAccessor(function(d) {console.log("Boxnumber test: "+d);return d })
        .group(na_nameGroup).title("National Average")
        .title("National Average");
			//console.log("national avg is:"+na_all);
         }
         else
             console.log('no filters');
    });
				//.filter([nearbyCompetition-5,nearbyCompetition+5]);
			dc.renderAll();

		</script>
	</div>
	<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br/><br/><br/><br/><br/>
	<div class='container' style='font: 12px sans-serif;color: white'>
		<h4>National Average</h4>
		<div id = "natAvg" style='color: black;'></div>
	</div>
	<br/><br/><br/><br/>
{% endblock %}